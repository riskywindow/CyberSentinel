
services:
  # ClickHouse for telemetry and event storage
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: cybersentinel-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./storage/clickhouse/ddl.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - cybersentinel

  # Neo4j for entity relationship graph
  neo4j:
    image: neo4j:5.12
    container_name: cybersentinel-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/test-password
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p test-password 'RETURN 1;' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 15s
    networks:
      - cybersentinel

  # NATS for message bus
  nats:
    image: nats:2.10-alpine
    container_name: cybersentinel-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--jetstream", "--http_port", "8222"]
    volumes:
      - nats_data:/data
    healthcheck:
      test: ["CMD", "nats", "pub", "test", "hello"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - cybersentinel

  # Redis for LangGraph state and caching
  redis:
    image: redis:7.2-alpine
    container_name: cybersentinel-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - cybersentinel

  # API service (FastAPI)
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: cybersentinel-api
    ports:
      - "8000:8000"
    environment:
      - CLICKHOUSE_URL=http://clickhouse:8123
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=test-password
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis://redis:6379
    depends_on:
      clickhouse:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
      - faiss_data:/app/data
    networks:
      - cybersentinel
    profiles: ["full"]  # Only start with make dev-full

  # UI service (Next.js)
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: cybersentinel-ui
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    depends_on:
      - api
    networks:
      - cybersentinel
    profiles: ["full"]

  # Optional: Kafka (alternative to NATS)
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: cybersentinel-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - cybersentinel
    profiles: ["kafka"]

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: cybersentinel-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - cybersentinel
    profiles: ["kafka"]

  # Optional: Grafana for observability
  grafana:
    image: grafana/grafana:10.2.0
    container_name: cybersentinel-grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./observability/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - cybersentinel
    profiles: ["observability"]

  # Optional: Tempo for tracing
  tempo:
    image: grafana/tempo:2.3.0
    container_name: cybersentinel-tempo
    command: ["-config.file=/etc/tempo.yaml"]
    ports:
      - "3200:3200"
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
    volumes:
      - ./observability/tempo/tempo.yaml:/etc/tempo.yaml
      - tempo_data:/tmp/tempo
    networks:
      - cybersentinel
    profiles: ["observability"]

volumes:
  clickhouse_data:
  neo4j_data:
  neo4j_logs:
  nats_data:
  redis_data:
  faiss_data:
  kafka_data:
  zookeeper_data:
  grafana_data:
  tempo_data:

networks:
  cybersentinel:
    driver: bridge