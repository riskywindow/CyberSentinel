id: patch_vulnerability
name: Emergency Vulnerability Patching
description: Apply critical security patches to address active exploits
risk_tier: medium
category: corrective
target_types:
  - host
  - service
  - application

estimated_duration: 30  # minutes
reversible: true
requires_approval: true

variables:
  cve_id:
    type: string
    required: true
    description: "CVE identifier for the vulnerability"
  patch_method:
    type: string
    default: "automatic"
    description: "Patching method: automatic, manual, or hotfix"
  reboot_required:
    type: boolean
    default: false
    description: "Whether system reboot is required"

steps:
  - name: identify_vulnerability
    action: shell
    command: "echo Identifying vulnerability {{cve_id}} on {{target_host}}"
    timeout: 60

  - name: check_patch_availability
    action: shell
    command: "echo Checking patch availability for {{cve_id}}"
    timeout: 120

  - name: create_system_backup
    action: shell
    command: "echo Creating system backup before patching"
    timeout: 300

  - name: download_patches
    action: shell
    command: "echo Downloading security patches for {{cve_id}}"
    timeout: 600

  - name: validate_patch_integrity
    action: shell
    command: "echo Validating patch integrity and signatures"
    timeout: 60

  - name: apply_patches
    action: shell
    command: "echo Applying security patches using {{patch_method}} method"
    timeout: 900

  - name: verify_patch_installation
    action: shell
    command: "echo Verifying patch installation was successful"
    timeout: 120

  - name: reboot_system
    action: shell
    command: "echo Rebooting system to complete patch installation"
    timeout: 300
    condition: "{{reboot_required}}"

  - name: post_patch_verification
    action: shell
    command: "echo Performing post-patch verification tests"
    timeout: 180

verify:
  - name: check_vulnerability_patched
    command: "echo Verifying vulnerability {{cve_id}} is patched"
    expected_output: "vulnerability patched"

revert:
  - name: restore_from_backup
    command: "echo Restoring system from pre-patch backup"
  - name: rollback_patches
    command: "echo Rolling back applied patches"