---
# ArgoCD Server ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-server
  namespace: argocd
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd

---
# ArgoCD Application Controller ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-application-controller
  namespace: argocd
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd

---
# ArgoCD Repo Server ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-repo-server
  namespace: argocd
  labels:
    app.kubernetes.io/component: repo-server
    app.kubernetes.io/name: argocd-repo-server
    app.kubernetes.io/part-of: argocd

---
# ArgoCD DEX Server ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-dex-server
  namespace: argocd
  labels:
    app.kubernetes.io/component: dex-server
    app.kubernetes.io/name: argocd-dex-server
    app.kubernetes.io/part-of: argocd

---
# ArgoCD Notifications Controller ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-notifications-controller
  namespace: argocd
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd

---
# ArgoCD Server ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-server
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  - configmaps
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - patch
  - delete
- apiGroups:
  - argoproj.io
  resources:
  - applications
  - appprojects
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - delete
  - patch
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - list
  - watch

---
# ArgoCD Application Controller ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-application-controller
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
rules:
- apiGroups:
  - "*"
  resources:
  - "*"
  verbs:
  - "*"
- nonResourceURLs:
  - "*"
  verbs:
  - "*"

---
# ArgoCD Application Controller ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-application-controller
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-application-controller
subjects:
- kind: ServiceAccount
  name: argocd-application-controller
  namespace: argocd

---
# ArgoCD Server ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-server
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-server
subjects:
- kind: ServiceAccount
  name: argocd-server
  namespace: argocd

---
# Environment-specific RBAC for CyberSentinel applications
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-cybersentinel-apps
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-cybersentinel-apps
    app.kubernetes.io/part-of: argocd
rules:
# Full access to CyberSentinel namespaces
- apiGroups:
  - ""
  resources:
  - "*"
  verbs:
  - "*"
  resourceNames: []
- apiGroups:
  - apps
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - extensions
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - networking.k8s.io
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - policy
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - autoscaling
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - batch
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - monitoring.coreos.com
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - external-secrets.io
  resources:
  - "*"
  verbs:
  - "*"

---
# ArgoCD CyberSentinel Apps ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-cybersentinel-apps
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-cybersentinel-apps
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-cybersentinel-apps
subjects:
- kind: ServiceAccount
  name: argocd-application-controller
  namespace: argocd

---
# ArgoCD Notifications Controller ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-notifications-controller
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
rules:
- apiGroups:
  - argoproj.io
  resources:
  - applications
  - appprojects
  verbs:
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - configmaps
  - secrets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - list

---
# ArgoCD Notifications Controller ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-notifications-controller
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-notifications-controller
subjects:
- kind: ServiceAccount
  name: argocd-notifications-controller
  namespace: argocd

---
# Environment-specific Role for Dev namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: cybersentinel-dev
  name: argocd-dev-manager
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-dev-manager
    app.kubernetes.io/part-of: argocd
rules:
- apiGroups:
  - ""
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - apps
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - extensions
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - networking.k8s.io
  resources:
  - "*"
  verbs:
  - "*"

---
# Environment-specific RoleBinding for Dev namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-dev-manager
  namespace: cybersentinel-dev
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-dev-manager
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-dev-manager
subjects:
- kind: ServiceAccount
  name: argocd-application-controller
  namespace: argocd

---
# Environment-specific Role for Staging namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: cybersentinel-staging
  name: argocd-staging-manager
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-staging-manager
    app.kubernetes.io/part-of: argocd
rules:
- apiGroups:
  - ""
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - apps
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - extensions
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - networking.k8s.io
  resources:
  - "*"
  verbs:
  - "*"

---
# Environment-specific RoleBinding for Staging namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-staging-manager
  namespace: cybersentinel-staging
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-staging-manager
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-staging-manager
subjects:
- kind: ServiceAccount
  name: argocd-application-controller
  namespace: argocd

---
# Environment-specific Role for Production namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: cybersentinel
  name: argocd-prod-manager
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-prod-manager
    app.kubernetes.io/part-of: argocd
rules:
- apiGroups:
  - ""
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - apps
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - extensions
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - networking.k8s.io
  resources:
  - "*"
  verbs:
  - "*"

---
# Environment-specific RoleBinding for Production namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-prod-manager
  namespace: cybersentinel
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-prod-manager
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-prod-manager
subjects:
- kind: ServiceAccount
  name: argocd-application-controller
  namespace: argocd

---
# CyberSentinel Application Team ServiceAccount (for CI/CD integration)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cybersentinel-deployer
  namespace: argocd
  labels:
    app.kubernetes.io/name: cybersentinel-deployer
    app.kubernetes.io/part-of: argocd
  annotations:
    # IRSA annotation for AWS permissions
    eks.amazonaws.com/role-arn: "arn:aws:iam::${AWS_ACCOUNT_ID}:role/cybersentinel-${ENVIRONMENT}-argocd-role"

---
# CyberSentinel Deployer Role (limited ArgoCD access for CI/CD)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cybersentinel-deployer
  labels:
    app.kubernetes.io/name: cybersentinel-deployer
    app.kubernetes.io/part-of: argocd
rules:
- apiGroups:
  - argoproj.io
  resources:
  - applications
  verbs:
  - get
  - list
  - create
  - update
  - patch
  - delete
  resourceNames: 
  - "cybersentinel-*"
- apiGroups:
  - argoproj.io
  resources:
  - appprojects
  verbs:
  - get
  - list
  resourceNames:
  - "cybersentinel"
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - get
  - list

---
# CyberSentinel Deployer ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cybersentinel-deployer
  labels:
    app.kubernetes.io/name: cybersentinel-deployer
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cybersentinel-deployer
subjects:
- kind: ServiceAccount
  name: cybersentinel-deployer
  namespace: argocd

---
# ArgoCD Notifications Controller Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-notifications-controller
  namespace: argocd
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-notifications-controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: argocd-notifications-controller
    spec:
      serviceAccountName: argocd-notifications-controller
      containers:
      - name: notifications-controller
        image: quay.io/argoproj/argocd:v2.8.4
        imagePullPolicy: Always
        command:
        - argocd-notifications
        args:
        - --loglevel
        - info
        - --logformat
        - text
        - --namespace
        - argocd
        - --argocd-repo-server
        - argocd-repo-server:8081
        ports:
        - containerPort: 9001
          name: webhook
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 999
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: ssh-known-hosts
          mountPath: /app/config/ssh
        - name: tls-certs
          mountPath: /app/config/tls
        - name: tmp
          mountPath: /tmp
        livenessProbe:
          httpGet:
            path: /healthz
            port: 9001
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /healthz
            port: 9001
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: ssh-known-hosts
        configMap:
          name: argocd-ssh-known-hosts-cm
      - name: tls-certs
        configMap:
          name: argocd-tls-certs-cm
      - name: tmp
        emptyDir: {}

---
# ArgoCD Notifications Controller Service
apiVersion: v1
kind: Service
metadata:
  name: argocd-notifications-controller
  namespace: argocd
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
spec:
  type: ClusterIP
  ports:
  - name: webhook
    port: 9001
    protocol: TCP
    targetPort: 9001
  selector:
    app.kubernetes.io/name: argocd-notifications-controller