# External Secrets Operator Helm Values
# This configures External Secrets Operator for secure secrets management

# Global configuration
global:
  # AWS account ID - will be populated by Terraform
  awsAccountId: ""
  # AWS region
  region: "us-west-2"
  # Environment name (dev, staging, prod)
  environment: ""
  # Project name
  projectName: "cybersentinel"
  # EKS cluster name
  clusterName: ""

# External Secrets Operator configuration
externalSecrets:
  # Main operator configuration
  operator:
    # Container image
    image:
      repository: ghcr.io/external-secrets/external-secrets
      tag: v0.9.11
      pullPolicy: IfNotPresent
    
    # Resources allocation
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    
    # Security context
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      capabilities:
        drop:
        - ALL
    
    # Pod security context
    podSecurityContext:
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault
    
    # Node assignment for system nodes
    nodeSelector:
      role: "system"
    
    # Tolerations for system nodes
    tolerations:
      - key: CriticalAddonsOnly
        operator: Exists
      - effect: NoSchedule
        key: node-role.kubernetes.io/master
    
    # High availability
    replicas: 2
    
    # Metrics and monitoring
    metrics:
      enabled: true
      port: 8080
      
    # Service monitor for Prometheus
    serviceMonitor:
      enabled: true
      namespace: monitoring
      labels:
        environment: "{{ .Values.global.environment }}"
        component: external-secrets

  # Webhook configuration
  webhook:
    # Container image
    image:
      repository: ghcr.io/external-secrets/external-secrets
      tag: v0.9.11
      pullPolicy: IfNotPresent
    
    # Resources allocation
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    
    # Security configuration
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      capabilities:
        drop:
        - ALL
    
    # Pod security context
    podSecurityContext:
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault
    
    # Network policy
    port: 9443
    hostNetwork: false
    
    # Certificate configuration
    certificate:
      generate: true
      secretName: external-secrets-webhook-cert
    
    # High availability
    replicas: 2
    
    # Node assignment
    nodeSelector:
      role: "system"
    
    # Tolerations
    tolerations:
      - key: CriticalAddonsOnly
        operator: Exists
      - effect: NoSchedule
        key: node-role.kubernetes.io/master

  # Certificate Controller
  certController:
    # Container image
    image:
      repository: ghcr.io/external-secrets/external-secrets
      tag: v0.9.11
      pullPolicy: IfNotPresent
    
    # Resources allocation
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    
    # Security configuration
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      capabilities:
        drop:
        - ALL
    
    # Pod security context
    podSecurityContext:
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault
    
    # Node assignment
    nodeSelector:
      role: "system"
    
    # Tolerations
    tolerations:
      - key: CriticalAddonsOnly
        operator: Exists
      - effect: NoSchedule
        key: node-role.kubernetes.io/master

# RBAC Configuration
rbac:
  create: true
  
# Service Account Configuration
serviceAccount:
  create: true
  name: "external-secrets"
  annotations:
    # IRSA role ARN - will be populated by deployment script
    eks.amazonaws.com/role-arn: "arn:aws:iam::{{ .Values.global.awsAccountId }}:role/{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-secrets"

# Custom Resource Definitions
installCRDs: true

# Namespace configuration
namespaceOverride: "external-secrets-system"

# Environment-specific configurations
environments:
  dev:
    operator:
      resources:
        limits:
          cpu: 50m
          memory: 64Mi
        requests:
          cpu: 25m
          memory: 32Mi
      replicas: 1
    webhook:
      resources:
        limits:
          cpu: 50m
          memory: 64Mi
        requests:
          cpu: 25m
          memory: 32Mi
      replicas: 1
    certController:
      resources:
        limits:
          cpu: 50m
          memory: 64Mi
        requests:
          cpu: 25m
          memory: 32Mi
    
  staging:
    operator:
      resources:
        limits:
          cpu: 75m
          memory: 96Mi
        requests:
          cpu: 40m
          memory: 48Mi
      replicas: 2
    webhook:
      resources:
        limits:
          cpu: 75m
          memory: 96Mi
        requests:
          cpu: 40m
          memory: 48Mi
      replicas: 2
    certController:
      resources:
        limits:
          cpu: 75m
          memory: 96Mi
        requests:
          cpu: 40m
          memory: 48Mi
    
  prod:
    operator:
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      replicas: 3
    webhook:
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      replicas: 3
    certController:
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi

# Advanced security settings
podSecurityStandards:
  enforce: "restricted"
  audit: "restricted"
  warn: "restricted"

# Network policies
networkPolicy:
  enabled: true
  ingress:
    # Allow traffic from application namespace
    - namespaceSelector:
        matchLabels:
          name: cybersentinel
    # Allow traffic from monitoring namespace  
    - namespaceSelector:
        matchLabels:
          name: monitoring
  egress:
    # Allow DNS resolution
    - to: []
      ports:
      - protocol: UDP
        port: 53
    # Allow HTTPS to AWS APIs
    - to: []
      ports:
      - protocol: TCP
        port: 443

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Additional labels
extraLabels:
  app.kubernetes.io/component: "secrets-management"
  app.kubernetes.io/part-of: "cybersentinel"

# Logging configuration
logging:
  level: info
  format: json

# Webhook configuration
webhook:
  # Enable webhook
  create: true
  
  # Certificate configuration
  certCheckInterval: "5m"
  certLookaheadInterval: "30d"
  
  # Timeout settings
  timeoutSeconds: 30
  
  # Security settings
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65534
    capabilities:
      drop:
      - ALL

# Prometheus monitoring
prometheus:
  enabled: true
  rules:
    enabled: true
    additionalLabels:
      prometheus: kube-prometheus
    spec:
      - alert: ExternalSecretsOperatorDown
        expr: up{job="external-secrets-operator"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "External Secrets Operator is down"
          description: "External Secrets Operator has been down for more than 5 minutes"
      
      - alert: ExternalSecretSyncFailure
        expr: increase(external_secrets_sync_calls_error_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "External Secret sync failure"
          description: "External Secret {{ $labels.name }} in namespace {{ $labels.namespace }} failed to sync"

# ClusterRole aggregation
clusterRole:
  # Create ClusterRole
  create: true
  
  # Additional rules for secrets management
  rules:
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["get", "list", "create", "update", "patch", "watch"]
    - apiGroups: [""]
      resources: ["configmaps"]  
      verbs: ["get", "list", "create", "update", "patch", "watch"]
    - apiGroups: ["apps"]
      resources: ["deployments"]
      verbs: ["get", "list", "watch"]

# Feature flags
featureGates:
  # Enable concurrent secret reconciliation
  concurrentSecretSyncs: 5
  
  # Enable secret replication
  enableSecretReplication: false
  
  # Enable secret refresh on certificate renewal
  enableSecretRefresh: true

# Global settings
concurrent: 1
enableFloodGate: false