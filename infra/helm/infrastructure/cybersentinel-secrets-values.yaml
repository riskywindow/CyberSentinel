# CyberSentinel External Secrets Configuration
# This configures SecretStore and ExternalSecret resources for the application

# Global configuration
global:
  # AWS account ID - will be populated by Terraform
  awsAccountId: ""
  # AWS region
  region: "us-west-2"
  # Environment name (dev, staging, prod)
  environment: ""
  # Project name
  projectName: "cybersentinel"
  # EKS cluster name
  clusterName: ""

# SecretStore configuration
secretStore:
  # Name of the SecretStore
  name: "cybersentinel-aws-secrets"
  
  # AWS provider configuration
  provider:
    service: SecretsManager
    region: "{{ .Values.global.region }}"
    
    # Authentication via IRSA
    auth:
      serviceAccount:
        name: "external-secrets"
        namespace: "external-secrets-system"

# Database secrets configuration
databaseSecrets:
  # Enable database secrets synchronization
  enabled: true
  
  # External secret configuration
  externalSecret:
    name: "cybersentinel-db-secrets"
    refreshInterval: "15s"
    
    # Target secret in Kubernetes
    target:
      name: "cybersentinel-db-secrets"
      type: "Opaque"
      creationPolicy: "Owner"
      
      # Template for secret data
      template:
        type: "Opaque"
        engineVersion: v2
        data:
          POSTGRES_USER: "postgres"
          POSTGRES_PASSWORD: "{{ .postgres_password }}"
          POSTGRES_HOST: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-db.{{ .Values.global.region }}.rds.amazonaws.com"
          POSTGRES_PORT: "5432"
          POSTGRES_DB: "cybersentinel"
          
          REDIS_AUTH_TOKEN: "{{ .redis_auth_token }}"
          REDIS_HOST: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-redis.{{ .Values.global.region }}.cache.amazonaws.com"
          REDIS_PORT: "6379"
          
          CLICKHOUSE_PASSWORD: "{{ .clickhouse_password }}"
          CLICKHOUSE_HOST: "clickhouse.{{ .Values.global.environment }}"
          CLICKHOUSE_PORT: "9000"
          
          NEO4J_PASSWORD: "{{ .neo4j_password }}"
          NEO4J_URI: "bolt://neo4j.{{ .Values.global.environment }}:7687"
          NEO4J_USER: "neo4j"
  
  # Data mapping from AWS Secrets Manager
  data:
    - secretKey: postgres_password
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-db-passwords"
        property: postgres_password
    - secretKey: redis_auth_token
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-db-passwords"
        property: redis_auth_token
    - secretKey: clickhouse_password
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-db-passwords"
        property: clickhouse_password
    - secretKey: neo4j_password
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-db-passwords"
        property: neo4j_password

# API secrets configuration
apiSecrets:
  # Enable API secrets synchronization
  enabled: true
  
  # External secret configuration
  externalSecret:
    name: "cybersentinel-api-secrets"
    refreshInterval: "15s"
    
    # Target secret in Kubernetes
    target:
      name: "cybersentinel-api-secrets"
      type: "Opaque"
      creationPolicy: "Owner"
      
      # Template for secret data
      template:
        type: "Opaque"
        engineVersion: v2
        data:
          JWT_SECRET: "{{ .jwt_secret }}"
          API_KEY: "{{ .api_key }}"
          WEBHOOK_SECRET: "{{ .webhook_secret }}"
          
          # Additional API configuration
          JWT_EXPIRATION: "24h"
          API_RATE_LIMIT: "1000"
          WEBHOOK_TIMEOUT: "30s"
  
  # Data mapping from AWS Secrets Manager
  data:
    - secretKey: jwt_secret
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-api-credentials"
        property: jwt_secret
    - secretKey: api_key
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-api-credentials"
        property: api_key
    - secretKey: webhook_secret
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-api-credentials"
        property: webhook_secret

# External service secrets configuration
externalServiceSecrets:
  # Enable external service secrets synchronization
  enabled: true
  
  # External secret configuration
  externalSecret:
    name: "cybersentinel-external-secrets"
    refreshInterval: "30s"  # Less frequent refresh for external services
    
    # Target secret in Kubernetes
    target:
      name: "cybersentinel-external-secrets"
      type: "Opaque"
      creationPolicy: "Owner"
      
      # Template for secret data
      template:
        type: "Opaque"
        engineVersion: v2
        data:
          # AI/ML Services
          OPENAI_API_KEY: "{{ .openai_api_key }}"
          OPENAI_API_URL: "https://api.openai.com/v1"
          OPENAI_MODEL: "gpt-4"
          
          # Alerting Services
          SLACK_WEBHOOK_URL: "{{ .slack_webhook_url }}"
          SLACK_CHANNEL: "#cybersentinel-alerts"
          PAGERDUTY_API_KEY: "{{ .pagerduty_api_key }}"
          PAGERDUTY_SERVICE_KEY: "{{ .pagerduty_service_key }}"
          
          # SIEM/Logging Services
          ELASTICSEARCH_URL: "{{ .elasticsearch_url }}"
          ELASTICSEARCH_USERNAME: "{{ .elasticsearch_username }}"
          ELASTICSEARCH_PASSWORD: "{{ .elasticsearch_password }}"
          SPLUNK_HEC_TOKEN: "{{ .splunk_hec_token }}"
          SPLUNK_HEC_URL: "{{ .splunk_hec_url }}"
          
          # Cloud Services
          AWS_ACCESS_KEY_ID: "{{ .aws_access_key_id }}"
          AWS_SECRET_ACCESS_KEY: "{{ .aws_secret_access_key }}"
  
  # Data mapping from AWS Secrets Manager
  data:
    - secretKey: openai_api_key
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: openai_api_key
    - secretKey: slack_webhook_url
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: slack_webhook_url
    - secretKey: pagerduty_api_key
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: pagerduty_api_key
    - secretKey: pagerduty_service_key
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: pagerduty_service_key
    - secretKey: elasticsearch_url
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: elasticsearch_url
    - secretKey: elasticsearch_username
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: elasticsearch_username
    - secretKey: elasticsearch_password
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: elasticsearch_password
    - secretKey: splunk_hec_token
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: splunk_hec_token
    - secretKey: splunk_hec_url
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: splunk_hec_url
    - secretKey: aws_access_key_id
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: aws_access_key_id
    - secretKey: aws_secret_access_key
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-external-services"
        property: aws_secret_access_key

# TLS/Certificate secrets configuration
tlsSecrets:
  # Enable TLS secrets synchronization
  enabled: true
  
  # External secret configuration
  externalSecret:
    name: "cybersentinel-tls-secrets"
    refreshInterval: "1h"  # Certificates change less frequently
    
    # Target secret in Kubernetes
    target:
      name: "cybersentinel-tls-certs"
      type: "kubernetes.io/tls"
      creationPolicy: "Owner"
      
      # Template for TLS secret
      template:
        type: "kubernetes.io/tls"
        engineVersion: v2
        data:
          tls.crt: "{{ .tls_certificate }}"
          tls.key: "{{ .tls_private_key }}"
          ca.crt: "{{ .ca_certificate }}"
  
  # Data mapping from AWS Secrets Manager
  data:
    - secretKey: tls_certificate
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-tls-certificates"
        property: certificate
    - secretKey: tls_private_key
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-tls-certificates"
        property: private_key
    - secretKey: ca_certificate
      remoteRef:
        key: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-tls-certificates"
        property: ca_certificate

# Environment-specific configurations
environments:
  dev:
    # More frequent refresh for development
    databaseSecrets:
      externalSecret:
        refreshInterval: "30s"
    apiSecrets:
      externalSecret:
        refreshInterval: "30s"
    externalServiceSecrets:
      externalSecret:
        refreshInterval: "60s"
    tlsSecrets:
      enabled: false  # Use self-signed certs in dev
    
  staging:
    # Standard refresh intervals
    databaseSecrets:
      externalSecret:
        refreshInterval: "15s"
    apiSecrets:
      externalSecret:
        refreshInterval: "15s"
    externalServiceSecrets:
      externalSecret:
        refreshInterval: "30s"
    tlsSecrets:
      enabled: true
    
  prod:
    # Conservative refresh for production stability
    databaseSecrets:
      externalSecret:
        refreshInterval: "60s"
    apiSecrets:
      externalSecret:
        refreshInterval: "60s"
    externalServiceSecrets:
      externalSecret:
        refreshInterval: "300s"  # 5 minutes
    tlsSecrets:
      enabled: true
      externalSecret:
        refreshInterval: "6h"  # Certificates change rarely

# Secret rotation configuration
secretRotation:
  # Enable automatic secret rotation
  enabled: true
  
  # Rotation policies
  policies:
    # Database passwords rotation
    database:
      enabled: true
      schedule: "0 2 * * 0"  # Weekly on Sunday 2 AM
      backupCount: 3
    
    # API credentials rotation
    api:
      enabled: true
      schedule: "0 3 1 * *"   # Monthly on 1st 3 AM
      backupCount: 2
    
    # External service credentials validation
    external:
      enabled: true
      schedule: "0 4 * * 1"   # Weekly on Monday 4 AM
      validateOnly: true  # Only validate, don't rotate

# Monitoring and alerting
monitoring:
  # Enable monitoring
  enabled: true
  
  # Metrics collection
  metrics:
    enabled: true
    interval: "30s"
  
  # Alerting rules
  alerts:
    # Secret sync failures
    secretSyncFailure:
      enabled: true
      threshold: 3
      window: "5m"
      severity: "warning"
    
    # Secret refresh failures
    secretRefreshFailure:
      enabled: true
      threshold: 1
      window: "1m"
      severity: "critical"
    
    # Secret age warnings
    secretAge:
      enabled: true
      maxAge: "90d"
      severity: "warning"

# Security configuration
security:
  # Enable security policies
  enabled: true
  
  # Secret validation
  validation:
    # Validate secret formats
    enabled: true
    rules:
      - name: password_complexity
        pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{12,}$"
        fields: ["*password*"]
      - name: api_key_format
        pattern: "^[A-Za-z0-9_-]{32,}$"
        fields: ["*api_key*", "*token*"]
  
  # Secret encryption
  encryption:
    # Enable additional encryption
    enabled: true
    algorithm: "AES256"
  
  # Access control
  access:
    # Restrict access to specific service accounts
    serviceAccounts:
      - "cybersentinel:default"
      - "cybersentinel:cybersentinel-api"
      - "cybersentinel:cybersentinel-ui"

# Backup and recovery
backup:
  # Enable secret backups
  enabled: true
  
  # Backup configuration
  schedule: "0 1 * * *"  # Daily at 1 AM
  retention: "30d"
  
  # Backup storage
  storage:
    type: "s3"
    bucket: "{{ .Values.global.projectName }}-{{ .Values.global.environment }}-secrets-backup"
    region: "{{ .Values.global.region }}"
    encryption: true

# Additional labels and annotations
extraLabels:
  app.kubernetes.io/component: "secrets-management"
  app.kubernetes.io/part-of: "cybersentinel"
  app.kubernetes.io/managed-by: "external-secrets"

extraAnnotations:
  external-secrets.io/backend-type: "secretsmanager"
  external-secrets.io/rotation-enabled: "true"