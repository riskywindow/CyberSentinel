{{- if .Values.rbac.enabled }}
---
# API Service Role - Core application operations
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "cybersentinel.fullname" . }}-api
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
rules:
# ConfigMaps and Secrets access for configuration
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list", "watch"]
  resourceNames: 
    - {{ include "cybersentinel.configMapName" . }}
    - {{ include "cybersentinel.fullname" . }}-secrets
# Pod management for health checks and logs
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
  resourceNames: []
# Events for audit logging
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
---
# API Service RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "cybersentinel.fullname" . }}-api
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
subjects:
- kind: ServiceAccount
  name: {{ include "cybersentinel.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "cybersentinel.fullname" . }}-api
---
# Scout Agent Role - Limited monitoring and data collection
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "cybersentinel.fullname" . }}-scout
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: scout
rules:
# Read-only access to configuration
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
  resourceNames: 
    - {{ include "cybersentinel.configMapName" . }}
# Read-only access to pods for monitoring
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list", "watch"]
# Events for security event correlation
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch", "create"]
# Limited network policy read access for security analysis
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list", "watch"]
---
# Scout Agent RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "cybersentinel.fullname" . }}-scout
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: scout
subjects:
- kind: ServiceAccount
  name: {{ include "cybersentinel.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "cybersentinel.fullname" . }}-scout
---
# Analyst Agent Role - Analysis and investigation permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "cybersentinel.fullname" . }}-analyst
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: analyst
rules:
# Configuration access
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
  resourceNames: 
    - {{ include "cybersentinel.configMapName" . }}
# Pod analysis permissions
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list", "watch"]
# Events for threat analysis
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch", "create", "patch"]
# Security policy analysis
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["policy"]
  resources: ["poddisruptionbudgets"]
  verbs: ["get", "list", "watch"]
# Service analysis for threat modeling
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
---
# Analyst Agent RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "cybersentinel.fullname" . }}-analyst
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: analyst
subjects:
- kind: ServiceAccount
  name: {{ include "cybersentinel.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "cybersentinel.fullname" . }}-analyst
---
# Responder Agent Role - Limited response actions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "cybersentinel.fullname" . }}-responder
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: responder
rules:
# Configuration access
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
  resourceNames: 
    - {{ include "cybersentinel.configMapName" . }}
# Pod management for incident response (limited scope)
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch", "delete"]
# Events for response logging
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch", "create", "patch"]
# Network policy updates for containment
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
# Service management for isolation
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch", "patch"]
---
# Responder Agent RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "cybersentinel.fullname" . }}-responder
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: responder
subjects:
- kind: ServiceAccount
  name: {{ include "cybersentinel.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "cybersentinel.fullname" . }}-responder
---
# UI Service Role - Minimal frontend permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "cybersentinel.fullname" . }}-ui
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: ui
rules:
# Configuration access (read-only)
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
  resourceNames: 
    - {{ include "cybersentinel.configMapName" . }}
# Events for UI notifications
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create"]
---
# UI Service RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "cybersentinel.fullname" . }}-ui
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: ui
subjects:
- kind: ServiceAccount
  name: {{ include "cybersentinel.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "cybersentinel.fullname" . }}-ui

{{- if .Values.rbac.clusterRole.enabled }}
---
# Cluster-level Role for cross-namespace threat monitoring (optional)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "cybersentinel.fullname" . }}-cluster-monitor
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
rules:
# Read-only access to security-related cluster resources
- apiGroups: [""]
  resources: ["nodes", "namespaces"]
  verbs: ["get", "list", "watch"]
# Network policy monitoring across namespaces
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list", "watch"]
# Pod security policy monitoring
- apiGroups: ["policy"]
  resources: ["podsecuritypolicies", "poddisruptionbudgets"]
  verbs: ["get", "list", "watch"]
# Security contexts and admission controllers
- apiGroups: ["extensions", "apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]
  resourceNames: []
# RBAC monitoring
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
  verbs: ["get", "list", "watch"]
---
# Cluster-level RoleBinding (only for designated monitoring pods)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "cybersentinel.fullname" . }}-cluster-monitor
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
    app.kubernetes.io/component: security
subjects:
- kind: ServiceAccount
  name: {{ include "cybersentinel.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "cybersentinel.fullname" . }}-cluster-monitor
{{- end }}

{{- end }}