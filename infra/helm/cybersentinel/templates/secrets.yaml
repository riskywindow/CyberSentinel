{{/* API Secrets */}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "cybersentinel.fullname" . }}-api-secrets
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.secrets.jwtSecret }}
  JWT_SECRET: {{ .Values.secrets.jwtSecret | b64enc }}
  {{- else }}
  JWT_SECRET: {{ randAlphaNum 32 | b64enc }}
  {{- end }}
  {{- if .Values.secrets.apiKey }}
  API_KEY: {{ .Values.secrets.apiKey | b64enc }}
  {{- else }}
  API_KEY: {{ randAlphaNum 64 | b64enc }}
  {{- end }}
  {{/* Optional external integrations for Responder agent */}}
  {{- if .Values.secrets.slackWebhookUrl }}
  SLACK_WEBHOOK_URL: {{ .Values.secrets.slackWebhookUrl | b64enc }}
  {{- end }}
  {{- if .Values.secrets.pagerdutyIntegrationKey }}
  PAGERDUTY_INTEGRATION_KEY: {{ .Values.secrets.pagerdutyIntegrationKey | b64enc }}
  {{- end }}

---
{{/* Database Secrets */}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "cybersentinel.fullname" . }}-db-secrets
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
type: Opaque
data:
  {{/* PostgreSQL Credentials */}}
  {{- if .Values.secrets.postgres.user }}
  POSTGRES_USER: {{ .Values.secrets.postgres.user | b64enc }}
  {{- else }}
  POSTGRES_USER: {{ "postgres" | b64enc }}
  {{- end }}
  {{- if .Values.secrets.postgres.password }}
  POSTGRES_PASSWORD: {{ .Values.secrets.postgres.password | b64enc }}
  {{- else }}
  POSTGRES_PASSWORD: {{ randAlphaNum 32 | b64enc }}
  {{- end }}
  
  {{/* Redis Credentials */}}
  {{- if .Values.secrets.redis.authToken }}
  REDIS_AUTH_TOKEN: {{ .Values.secrets.redis.authToken | b64enc }}
  {{- else }}
  REDIS_AUTH_TOKEN: {{ randAlphaNum 32 | b64enc }}
  {{- end }}
  
  {{/* ClickHouse Credentials */}}
  {{- if .Values.secrets.clickhouse.password }}
  CLICKHOUSE_PASSWORD: {{ .Values.secrets.clickhouse.password | b64enc }}
  {{- else }}
  CLICKHOUSE_PASSWORD: {{ randAlphaNum 32 | b64enc }}
  {{- end }}
  
  {{/* Neo4j Credentials */}}
  {{- if .Values.secrets.neo4j.password }}
  NEO4J_PASSWORD: {{ .Values.secrets.neo4j.password | b64enc }}
  {{- else }}
  NEO4J_PASSWORD: {{ randAlphaNum 32 | b64enc }}
  {{- end }}

{{- if .Values.externalSecrets.enabled }}
---
{{/* External Secret for API Secrets from AWS Secrets Manager */}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "cybersentinel.fullname" . }}-api-external-secret
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
spec:
  secretStoreRef:
    name: {{ include "cybersentinel.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: {{ include "cybersentinel.fullname" . }}-api-secrets
    creationPolicy: Owner
  data:
  - secretKey: JWT_SECRET
    remoteRef:
      key: {{ .Values.externalSecrets.apiSecretsPath | default "cybersentinel/api" }}
      property: jwt_secret
  - secretKey: API_KEY
    remoteRef:
      key: {{ .Values.externalSecrets.apiSecretsPath | default "cybersentinel/api" }}
      property: api_key

---
{{/* External Secret for Database Secrets */}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "cybersentinel.fullname" . }}-db-external-secret
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
spec:
  secretStoreRef:
    name: {{ include "cybersentinel.fullname" . }}-secret-store
    kind: SecretStore
  target:
    name: {{ include "cybersentinel.fullname" . }}-db-secrets
    creationPolicy: Owner
  data:
  - secretKey: POSTGRES_USER
    remoteRef:
      key: {{ .Values.externalSecrets.dbSecretsPath | default "cybersentinel/database" }}
      property: postgres_user
  - secretKey: POSTGRES_PASSWORD
    remoteRef:
      key: {{ .Values.externalSecrets.dbSecretsPath | default "cybersentinel/database" }}
      property: postgres_password
  - secretKey: REDIS_AUTH_TOKEN
    remoteRef:
      key: {{ .Values.externalSecrets.dbSecretsPath | default "cybersentinel/database" }}
      property: redis_auth_token
  - secretKey: CLICKHOUSE_PASSWORD
    remoteRef:
      key: {{ .Values.externalSecrets.dbSecretsPath | default "cybersentinel/database" }}
      property: clickhouse_password
  - secretKey: NEO4J_PASSWORD
    remoteRef:
      key: {{ .Values.externalSecrets.dbSecretsPath | default "cybersentinel/database" }}
      property: neo4j_password

---
{{/* AWS Secret Store */}}
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ include "cybersentinel.fullname" . }}-secret-store
  labels:
    {{- include "cybersentinel.labels" . | nindent 4 }}
spec:
  provider:
    aws:
      service: SecretsManager
      region: {{ .Values.externalSecrets.secretStore.region }}
      {{- if .Values.externalSecrets.secretStore.role }}
      role: {{ .Values.externalSecrets.secretStore.role }}
      {{- end }}
      auth:
        serviceAccount:
          name: {{ include "cybersentinel.serviceAccountName" . }}
{{- end }}